# Система управления картами банка

**Цель**: Разработка защищённой backend-системы для управления банковскими картами с поддержкой ролей, CRUD-операций, лимитов и истории транзакций, включая реализацию перевода средств и обработки платежей через распределённые транзакции с использованием паттерна SAGA.
## Используемый стек

- Java 23, Spring Boot, Spring Security, Spring JPA, Spring Web
- PostgreSQL, Liquibase, Redis
- Docker, Docker Compose, Kubernetes
- Swagger, OpenAPI
- Apache Kafka
- JUnit, Mockito
## Реализованный функционал
### Возможности администратора
- Создание, активация, блокировка и удаление банковских карт
- Просмотр всех карт и всей истории транзакций в системе
- Управление пользователями
- Установка лимитов на операции по картам (например, дневной или месячный лимит)
### Возможности пользователя
- Просмотр собственных карт
- Просмотр истории транзакций по своим картам
- Переводы средств между любыми картами в системе
- Перевод средств с карты на карту с проверкой установленных лимитов
- Получение списков карт и транзакций с фильтрацией и пагинацией
- Получение детализированных сообщений об ошибках при некорректных запросах
### Ограничения доступа
- Пользователь видит только свои карты и связанные с ними транзакции
- Администратор не имеет доступа к чувствительным данным пользователей: номера карт отображаются в маскированном виде, пароли не возвращаются
- Доступ к данным строго контролируется на уровне ролей и принадлежности ресурсов

![Pasted image 20250506012421](https://github.com/user-attachments/assets/4bf7a1dc-2f20-4d10-aa99-959c41c4c258)

## Краткое описание реализации

Реализована полноценная микросервисную архитектура, где каждый сервис отвечает за свою зону ответственности:
- **user** - отвечает за управление пользователями, за утентификацию запросов и выдачу JWT-токенов
- **card** - отвечает за управление картами (создание, удаление, блокировка, активация, получение), а также непосредственно списывает деньги в распределенной транзакции
- **limit** - отвечает за хранение и изменение лимитов по картам, а также проверяет возможность совершения денежного перевода
- **transaction** - хранит транзакции по картам, занимается инициализацией и оркестрацией распределенной транзакции перевода средств между картами

Сервисы взаимодействуют между собой для обеспечения консистености, к примеру, сервис карт перед созданием запрашивает информацию о том, существует ли пользователь, для которого создается банковская карта. Для реализации взаимодействия между микросервисами была использована **Kafka**, так как она обеспечивает наилучшую производительность и масштабируемость в сравнении с аналогами. Все сервисы являются идемпотентными, что необходимо для корректного выполнения операций.
## Распределенная транзакция перевода

Перевод средств осуществляется через SAGA c оркестратором (сервис transaction) и происходит в три этапа. Пользователь отправляет запрос о создании транзакции, на сервере создается зачаток будущей транзакции и отправляется пользователю, проверить статус можно через GET запрос. Раз в некоторое время в этом сервисе работает служба, которая получает необработанные транзакции и начинает инициацию транзакции, либо пробует делать повтор. За раз микросервис может обработать сколько угодно транзакций на разные карты, если же прилетает запрос, где используется карта, которая прямо сейчас обрабатывается, то она пропускается до следующей выборки. 

Второй этап это проверка лимитов, которую осуществляет соответствующий микросервис, он сравнивает приведенные от оркестратора данные о последних транзакциях с лимитами по карте и принимает решение об одобрении или отклонении платежа. Далее оркестратор отправляет запрос на формирование платежа, остальные проверки совершает уже сервис карт. Если оба микросервиса подтвердили выполнение, то микросервис транзакций завершает выполнение и создает конечный объект в БД.
